(()=>{"use strict";function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t(e)}function e(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function n(t,e){for(var n=0;n<e.length;n++){var a=e[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}function a(t,e,a){return e&&n(t.prototype,e),a&&n(t,a),t}for(var i={VERSION:"2.0.16",NOTES:[],HEADER_CHUNK_LENGTH:14,CIRCLE_OF_FOURTHS:["C","F","Bb","Eb","Ab","Db","Gb","Cb","Fb","Bbb","Ebb","Abb"],CIRCLE_OF_FIFTHS:["C","G","D","A","E","B","F#","C#","G#","D#","A#","E#"]},s=[["C"],["C#","Db"],["D"],["D#","Eb"],["E"],["F"],["F#","Gb"],["G"],["G#","Ab"],["A"],["A#","Bb"],["B"]],r=0,o=function(t){s.forEach((function(e){e.forEach((function(e){return i.NOTES[r]=e+t})),r++}))},h=-1;h<=9;h++)o(h);var u=function(){function t(){e(this,t)}return a(t,null,[{key:"byteToHex",value:function(t){return("0"+t.toString(16)).slice(-2)}},{key:"bytesToHex",value:function(e){var n=[];return e.forEach((function(e){return n.push(t.byteToHex(e))})),n.join("")}},{key:"hexToNumber",value:function(t){return parseInt(t,16)}},{key:"bytesToNumber",value:function(e){return t.hexToNumber(t.bytesToHex(e))}},{key:"bytesToLetters",value:function(t){var e=[];return t.forEach((function(t){return e.push(String.fromCharCode(t))})),e.join("")}},{key:"decToBinary",value:function(t){return(t>>>0).toString(2)}},{key:"getVarIntLength",value:function(t){for(var e=t[0],n=1;e>=128;)e=t[n],n++;return n}},{key:"readVarInt",value:function(t){var e=0;return t.forEach((function(t){128&t?(e+=127&t,e<<=7):e+=t})),e}},{key:"atob",value:function(t){function e(e){return t.apply(this,arguments)}return e.toString=function(){return t.toString()},e}((function(t){return"function"==typeof atob?atob(t):Buffer.from(t,"base64").toString("binary")}))}]),t}(),l=function(){function t(n,a){e(this,t),this.enabled=!0,this.eventIndex=0,this.pointer=0,this.lastTick=0,this.lastStatus=null,this.index=n,this.data=a,this.delta=0,this.runningDelta=0,this.events=[];var i=this.data.subarray(this.data.length-3,this.data.length);if(255!==i[0]||47!==i[1]||0!==i[2])throw"Invalid MIDI file; Last three bytes of track "+this.index+"must be FF 2F 00 to mark end of track"}return a(t,[{key:"reset",value:function(){return this.enabled=!0,this.eventIndex=0,this.pointer=0,this.lastTick=0,this.lastStatus=null,this.delta=0,this.runningDelta=0,this}},{key:"enable",value:function(){return this.enabled=!0,this}},{key:"disable",value:function(){return this.enabled=!1,this}},{key:"setEventIndexByTick",value:function(t){for(var e in t=t||0,this.events)if(this.events[e].tick>=t)return this.eventIndex=e,this}},{key:"getCurrentByte",value:function(){return this.data[this.pointer]}},{key:"getDeltaByteCount",value:function(){return u.getVarIntLength(this.data.subarray(this.pointer))}},{key:"getDelta",value:function(){return u.readVarInt(this.data.subarray(this.pointer,this.pointer+this.getDeltaByteCount()))}},{key:"handleEvent",value:function(t,e){if(e=e||!1){var n=t-this.lastTick>=this.getDelta();if(this.pointer<this.data.length&&(e||n)){var a=this.parseEvent();if(this.enabled)return a}}else if(this.events[this.eventIndex]&&this.events[this.eventIndex].tick<=t&&(this.eventIndex++,this.enabled))return this.events[this.eventIndex-1];return null}},{key:"getStringData",value:function(t){var e=u.getVarIntLength(this.data.subarray(t+2)),n=u.readVarInt(this.data.subarray(t+2,t+2+e));return u.bytesToLetters(this.data.subarray(t+2+e,t+2+e+n))}},{key:"parseEvent",value:function(){var t=this.pointer+this.getDeltaByteCount(),e={},n=this.getDeltaByteCount();if(e.track=this.index+1,e.delta=this.getDelta(),this.lastTick=this.lastTick+e.delta,this.runningDelta+=e.delta,e.tick=this.runningDelta,e.byteIndex=this.pointer,255==this.data[t]){switch(this.data[t+1]){case 0:e.name="Sequence Number";break;case 1:e.name="Text Event",e.string=this.getStringData(t);break;case 2:e.name="Copyright Notice";break;case 3:e.name="Sequence/Track Name",e.string=this.getStringData(t);break;case 4:e.name="Instrument Name",e.string=this.getStringData(t);break;case 5:e.name="Lyric",e.string=this.getStringData(t);break;case 6:e.name="Marker";break;case 7:e.name="Cue Point",e.string=this.getStringData(t);break;case 9:e.name="Device Name",e.string=this.getStringData(t);break;case 32:e.name="MIDI Channel Prefix";break;case 33:e.name="MIDI Port",e.data=u.bytesToNumber([this.data[t+3]]);break;case 47:e.name="End of Track";break;case 81:e.name="Set Tempo",e.data=Math.round(6e7/u.bytesToNumber(this.data.subarray(t+3,t+6))),this.tempo=e.data;break;case 84:e.name="SMTPE Offset";break;case 88:e.name="Time Signature",e.data=this.data.subarray(t+3,t+7),e.timeSignature=e.data[0]+"/"+Math.pow(2,e.data[1]);break;case 89:e.name="Key Signature",e.data=this.data.subarray(t+3,t+5),e.data[0]>=0?e.keySignature=i.CIRCLE_OF_FIFTHS[e.data[0]]:e.data[0]<0&&(e.keySignature=i.CIRCLE_OF_FOURTHS[Math.abs(e.data[0])]),0==e.data[1]?e.keySignature+=" Major":1==e.data[1]&&(e.keySignature+=" Minor");break;case 127:e.name="Sequencer-Specific Meta-event";break;default:e.name="Unknown: "+this.data[t+1].toString(16)}var a=u.getVarIntLength(this.data.subarray(t+2)),s=u.readVarInt(this.data.subarray(t+2,t+2+a));this.pointer+=n+3+s}else if(240===this.data[t]){e.name="Sysex";var r=u.getVarIntLength(this.data.subarray(t+1)),o=u.readVarInt(this.data.subarray(t+1,t+1+r));e.data=this.data.subarray(t+1+r,t+1+r+o),this.pointer+=n+1+r+o}else if(247===this.data[t]){e.name="Sysex (escape)";var h=u.getVarIntLength(this.data.subarray(t+1)),l=u.readVarInt(this.data.subarray(t+1,t+1+h));e.data=this.data.subarray(t+1+h,t+1+h+l),this.pointer+=n+1+h+l}else if(this.data[t]<128)if(e.running=!0,e.noteNumber=this.data[t],e.noteName=i.NOTES[this.data[t]],e.velocity=this.data[t+1],this.lastStatus<=143)e.name="Note off",e.channel=this.lastStatus-128+1,this.pointer+=n+2;else if(this.lastStatus<=159)e.name="Note on",e.channel=this.lastStatus-144+1,this.pointer+=n+2;else if(this.lastStatus<=175)e.name="Polyphonic Key Pressure",e.channel=this.lastStatus-160+1,e.note=i.NOTES[this.data[t+1]],e.pressure=event[1],this.pointer+=n+2;else if(this.lastStatus<=191)e.name="Controller Change",e.channel=this.lastStatus-176+1,e.number=this.data[t+1],e.value=this.data[t+2],this.pointer+=n+2;else if(this.lastStatus<=207)e.name="Program Change",e.channel=this.lastStatus-192+1,e.value=this.data[t+1],this.pointer+=n+1;else if(this.lastStatus<=223)e.name="Channel Key Pressure",e.channel=this.lastStatus-208+1,this.pointer+=n+1;else{if(!(this.lastStatus<=239))throw"Unknown event (running): ".concat(this.lastStatus);e.name="Pitch Bend",e.channel=this.lastStatus-224+1,e.value=this.data[t+2],this.pointer+=n+2}else if(this.lastStatus=this.data[t],this.data[t]<=143)e.name="Note off",e.channel=this.lastStatus-128+1,e.noteNumber=this.data[t+1],e.noteName=i.NOTES[this.data[t+1]],e.velocity=Math.round(this.data[t+2]/127*100),this.pointer+=n+3;else if(this.data[t]<=159)e.name="Note on",e.channel=this.lastStatus-144+1,e.noteNumber=this.data[t+1],e.noteName=i.NOTES[this.data[t+1]],e.velocity=Math.round(this.data[t+2]/127*100),this.pointer+=n+3;else if(this.data[t]<=175)e.name="Polyphonic Key Pressure",e.channel=this.lastStatus-160+1,e.note=i.NOTES[this.data[t+1]],e.pressure=event[2],this.pointer+=n+3;else if(this.data[t]<=191)e.name="Controller Change",e.channel=this.lastStatus-176+1,e.number=this.data[t+1],e.value=this.data[t+2],this.pointer+=n+3;else if(this.data[t]<=207)e.name="Program Change",e.channel=this.lastStatus-192+1,e.value=this.data[t+1],this.pointer+=n+2;else if(this.data[t]<=223)e.name="Channel Key Pressure",e.channel=this.lastStatus-208+1,this.pointer+=n+2;else{if(!(this.data[t]<=239))throw"Unknown event: ".concat(this.data[t]);e.name="Pitch Bend",e.channel=this.lastStatus-224+1,this.pointer+=n+3}return this.delta+=e.delta,this.events.push(e),e}},{key:"endOfTrack",value:function(){return 255==this.data[this.pointer+1]&&47==this.data[this.pointer+2]&&0==this.data[this.pointer+3]}}]),t}();Uint8Array.prototype.forEach||Object.defineProperty(Uint8Array.prototype,"forEach",{value:Array.prototype.forEach});var c=function(){function n(t,a){e(this,n),this.sampleRate=5,this.startTime=0,this.buffer=a||null,this.midiChunksByteLength=null,this.division,this.format,this.setIntervalId=!1,this.tracks=[],this.instruments=[],this.defaultTempo=120,this.tempo=null,this.startTick=0,this.tick=0,this.lastTick=null,this.inLoop=!1,this.totalTicks=0,this.events=[],this.totalEvents=0,this.eventListeners={},"function"==typeof t&&this.on("midiEvent",t)}return a(n,[{key:"loadFile",value:function(t){throw"loadFile is only supported on Node.js"}},{key:"loadArrayBuffer",value:function(t){return this.buffer=new Uint8Array(t),this.fileLoaded()}},{key:"loadDataUri",value:function(t){for(var e=u.atob(t.split(",")[1]),n=new Uint8Array(e.length),a=0;a<e.length;a++)n[a]=e.charCodeAt(a);return this.buffer=n,this.fileLoaded()}},{key:"getFilesize",value:function(){return this.buffer?this.buffer.length:0}},{key:"fileLoaded",value:function(){if(!this.validate())throw"Invalid MIDI file; should start with MThd";return this.setTempo(this.defaultTempo).getDivision().getFormat().getTracks().dryRun()}},{key:"validate",value:function(){return"MThd"===u.bytesToLetters(this.buffer.subarray(0,4))}},{key:"getFormat",value:function(){return this.format=u.bytesToNumber(this.buffer.subarray(8,10)),this}},{key:"getTracks",value:function(){this.tracks=[];for(var t=0;t<this.buffer.length;){if("MTrk"==u.bytesToLetters(this.buffer.subarray(t,t+4))){var e=u.bytesToNumber(this.buffer.subarray(t+4,t+8));this.tracks.push(new l(this.tracks.length,this.buffer.subarray(t+8,t+8+e)))}t+=u.bytesToNumber(this.buffer.subarray(t+4,t+8))+8}var n=0;return this.tracks.forEach((function(t){n+=8+t.data.length})),this.midiChunksByteLength=i.HEADER_CHUNK_LENGTH+n,this}},{key:"enableTrack",value:function(t){return this.tracks[t-1].enable(),this}},{key:"disableTrack",value:function(t){return this.tracks[t-1].disable(),this}},{key:"getDivision",value:function(){return this.division=u.bytesToNumber(this.buffer.subarray(12,i.HEADER_CHUNK_LENGTH)),this}},{key:"playLoop",value:function(t){this.inLoop||(this.inLoop=!0,this.tick=this.getCurrentTick(),this.tracks.forEach((function(e,n){if(!t&&this.endOfFile())this.triggerPlayerEvent("endOfFile"),this.stop();else{var a=e.handleEvent(this.tick,t);t&&a?(a.hasOwnProperty("name")&&"Set Tempo"===a.name&&(this.defaultTempo=a.data,this.setTempo(a.data)),a.hasOwnProperty("name")&&"Program Change"===a.name&&(this.instruments.includes(a.value)||this.instruments.push(a.value))):a&&(a.hasOwnProperty("name")&&"Set Tempo"===a.name&&(this.setTempo(a.data),this.isPlaying()&&this.pause().play()),this.emitEvent(a))}}),this),t||this.triggerPlayerEvent("playing",{tick:this.tick}),this.inLoop=!1)}},{key:"setTempo",value:function(t){return this.tempo=t,this}},{key:"setStartTime",value:function(t){return this.startTime=t,this}},{key:"play",value:function(){if(this.isPlaying())throw"Already playing...";return this.startTime||(this.startTime=(new Date).getTime()),this.setIntervalId=setInterval(this.playLoop.bind(this),this.sampleRate),this}},{key:"loop",value:function(){setTimeout(function(){this.playLoop(),this.loop()}.bind(this),this.sampleRate)}},{key:"pause",value:function(){return clearInterval(this.setIntervalId),this.setIntervalId=!1,this.startTick=this.tick,this.startTime=0,this}},{key:"stop",value:function(){return clearInterval(this.setIntervalId),this.setIntervalId=!1,this.startTick=0,this.startTime=0,this.resetTracks(),this}},{key:"skipToTick",value:function(t){return this.stop(),this.startTick=t,this.tracks.forEach((function(e){e.setEventIndexByTick(t)})),this}},{key:"skipToPercent",value:function(t){if(t<0||t>100)throw"Percent must be number between 1 and 100.";return this.skipToTick(Math.round(t/100*this.totalTicks)),this}},{key:"skipToSeconds",value:function(t){var e=this.getSongTime();if(t<0||t>e)throw t+" seconds not within song time of "+e;return this.skipToPercent(t/e*100),this}},{key:"isPlaying",value:function(){return this.setIntervalId>0||"object"===t(this.setIntervalId)}},{key:"dryRun",value:function(){for(this.resetTracks();!this.endOfFile();)this.playLoop(!0);return this.events=this.getEvents(),this.totalEvents=this.getTotalEvents(),this.totalTicks=this.getTotalTicks(),this.startTick=0,this.startTime=0,this.resetTracks(),this.triggerPlayerEvent("fileLoaded",this),this}},{key:"resetTracks",value:function(){return this.tracks.forEach((function(t){return t.reset()})),this}},{key:"getEvents",value:function(){return this.tracks.map((function(t){return t.events}))}},{key:"getTotalTicks",value:function(){return Math.max.apply(null,this.tracks.map((function(t){return t.delta})))}},{key:"getTotalEvents",value:function(){return this.tracks.reduce((function(t,e){return{events:{length:t.events.length+e.events.length}}}),{events:{length:0}}).events.length}},{key:"getSongTime",value:function(){return this.totalTicks/this.division/this.tempo*60}},{key:"getSongTimeRemaining",value:function(){return Math.round((this.totalTicks-this.getCurrentTick())/this.division/this.tempo*60)}},{key:"getSongPercentRemaining",value:function(){return Math.round(this.getSongTimeRemaining()/this.getSongTime()*100)}},{key:"bytesProcessed",value:function(){return i.HEADER_CHUNK_LENGTH+8*this.tracks.length+this.tracks.reduce((function(t,e){return{pointer:t.pointer+e.pointer}}),{pointer:0}).pointer}},{key:"eventsPlayed",value:function(){return this.tracks.reduce((function(t,e){return{eventIndex:t.eventIndex+e.eventIndex}}),{eventIndex:0}).eventIndex}},{key:"endOfFile",value:function(){return this.isPlaying()?this.totalTicks-this.tick<=0:this.bytesProcessed()>=this.midiChunksByteLength}},{key:"getCurrentTick",value:function(){return this.startTime?Math.round(((new Date).getTime()-this.startTime)/1e3*(this.division*(this.tempo/60)))+this.startTick:this.startTick}},{key:"emitEvent",value:function(t){return this.triggerPlayerEvent("midiEvent",t),this}},{key:"on",value:function(t,e){return this.eventListeners.hasOwnProperty(t)||(this.eventListeners[t]=[]),this.eventListeners[t].push(e),this}},{key:"triggerPlayerEvent",value:function(t,e){return this.eventListeners.hasOwnProperty(t)&&this.eventListeners[t].forEach((function(t){return t(e||{})})),this}}]),n}(),d={Player:c,Utils:u,Constants:i};document.body;const f=document.querySelector(".play-pause-button"),y=document.querySelector(".seek-slider"),m=document.getElementById("current-time"),v=document.getElementById("duration"),k=document.querySelector(".song-selector"),b=document.getElementById("piano");let g,p=!1,T=document.createElement("audio");const S=t=>{T.src=t,T.load(),p=!1,f.src="icons/play-button.svg",g=setInterval(w)},E=()=>{p?C():I(),p=!p,f.src=p?"icons/pause-button.svg":"icons/play-button.svg"},I=()=>{T.play(),N.play()},C=()=>{T.pause(),N.pause()};f.addEventListener("click",E),y.addEventListener("change",(()=>{const t=T.duration*(y.value/100);p&&C(),T.currentTime=t,N.skipToSeconds(t),P(),p&&I()}));const w=()=>{if(!isNaN(T.duration)){y.value=T.currentTime*(100/T.duration);let t=Math.floor(T.currentTime/60),e=Math.floor(T.currentTime-60*t),n=Math.floor(T.duration/60),a=Math.floor(T.duration-60*n);e<10&&(e="0"+e),a<10&&(a="0"+a),m.textContent=t+":"+e,v.textContent=n+":"+a}};k.addEventListener("change",(()=>{p&&E(),S("songs/"+k.value+".wav"),D(k.value),P()})),S("songs/"+k.value+".wav");const N=new d.Player((t=>{}));N.on("midiEvent",(t=>{t.noteName?L((t=>{const e=t.slice(0,t.length-1),n=t[t.length-1]-1;let a,i=!0;switch(e){case"A":a=7*(n+1);break;case"B":a=7*(n+1)+1;break;case"C":a=7*n+2;break;case"D":a=7*n+3;break;case"E":a=7*n+4;break;case"F":a=7*n+5;break;case"G":a=7*n+6;break;case"Ab":a=7*(n+1),i=!1;break;case"Bb":a=7*(n+1)+1,i=!1;break;case"Db":a=7*n+3,i=!1;break;case"Eb":a=7*n+4,i=!1;break;case"Gb":a=7*n+6,i=!1}return{position:a,white:i}})(t.noteName),t.noteNumber,"Note on"===t.name,t.noteName):"Set Tempo"===t.name&&N.setTempo(t.data)}));const L=(t,e,n,a)=>{if(n){const n=document.createElement("div");n.classList+="key";const a=document.body.clientWidth,i=document.body.clientHeight;t.white?n.style=`height: ${i/8.3/i*100}vw;\n            left:${a/52*t.position/a*100+.1}vw;\n            width: ${a/52/a*100}vw;\n            background-color: #15904e;\n            border-radius: 3px;\n            border-color: black;`:n.style=`height: ${i/12.5/i*100}vw;\n            bottom: ${i/25/i*100}vw;\n            left:${a/52*t.position/a*100-.5}vw;\n            width: ${a/100/a*100}vw;\n            background-color: #165533;\n            z-index: 100;`,n.id=e,b.appendChild(n)}else document.getElementById(e)&&b.removeChild(document.getElementById(e))},P=()=>{for(;document.querySelector(".key");)b.removeChild(document.querySelector(".key"))},x={Inquisitive:"https://s3.amazonaws.com/alexmelfi.com/music/midi/Inquisitive.uri","New Joy":"https://s3.amazonaws.com/alexmelfi.com/music/midi/New+Joy.uri","Chord Experiments":"https://s3.amazonaws.com/alexmelfi.com/music/midi/Chord+Experiments.uri",Procrastination:"https://s3.amazonaws.com/alexmelfi.com/music/midi/Procrastination.uri","Stony Walk":"https://s3.amazonaws.com/alexmelfi.com/music/midi/Stony+Walk.uri"},D=t=>fetch(x[t]).then((t=>t.text())).then((t=>{N.loadDataUri(t)}));D(k.value)})();